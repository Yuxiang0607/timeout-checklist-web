<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>OR Timeout Checker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #f4f5f7, #e8ebee);
      margin: 0;
      padding: 24px;
      color: #222;
    }

    .card {
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.08);
      padding: 24px;
      margin: 18px auto;
      max-width: 900px;
      transition: transform 0.2s ease, box-shadow 0.3s ease;
    }

    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 22px rgba(0, 0, 0, 0.12);
    }

    h2 {
      margin: 0 0 14px 0;
      font-weight: 600;
      font-size: 1.4em;
      color: #333;
      border-left: 5px solid #444;
      padding-left: 10px;
    }

    .item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f8f9fb;
      border-radius: 12px;
      padding: 16px 18px;
      margin: 10px 0;
      font-size: 1.05em;
      color: #111;
      transition: background 0.3s ease;
    }

    .item:hover {
      background: #eef1f5;
    }

    .dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #e74c3c; /* red */
      cursor: pointer;
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.2);
      transition: background 0.3s ease, transform 0.15s ease;
    }

    .dot.ok {
      background: #27ae60; /* green */
      transform: scale(1.2);
    }

    .row {
      display: flex;
      gap: 12px;
      margin: 10px 0;
    }

    button {
      border: 0;
      border-radius: 10px;
      padding: 10px 18px;
      cursor: pointer;
      font-size: 1em;
      font-weight: 500;
      transition: background 0.3s ease, transform 0.1s ease;
    }

    button.primary {
      background: #222;
      color: #fff;
    }

    button.primary:hover {
      background: #444;
      transform: scale(1.03);
    }

    button.secondary {
      background: #e9edf2;
      color: #333;
    }

    button.secondary:hover {
      background: #dfe3e9;
      transform: scale(1.03);
    }

    .log {
      white-space: pre-wrap;
      background: #0a0a0a;
      color: #d6ffd6;
      border-radius: 10px;
      padding: 12px;
      font-size: 13px;
      max-height: 200px;
      overflow: auto;
      margin-top: 10px;
    }

    a {
      color: #007bff;
      text-decoration: none;
      font-weight: 500;
    }

    a:hover {
      text-decoration: underline;
    }
  </style>
</head>

<body>
  <div class="card">
    <h2>Audio Controls</h2>
    <div class="row">
      <button id="btnStart" class="primary">üéôÔ∏è Start</button>
      <button id="btnStop" class="secondary" disabled>‚èπÔ∏è Stop & Upload</button>
      <button id="btnReset" class="secondary">üîÑ Reset Lights</button>
      <a id="dl" style="display:none" target="_blank">Download transcript</a>
    </div>
    <small>Recording format: WebM (Opus). Your API key stays on the server.</small>
    <div id="status" class="log"></div>
  </div>

  <div class="card" id="checklist"></div>

<script>
const BACKEND_BASE = "https://timeout-checklist-server.onrender.com";

const GROUPS = [
  ["Timeout Initiation", [
    "Is everyone ready to begin the timeout?",
    "Do we have the consent for in front of us?"
  ]],
  ["Team Introduction", [
    "Please introduce yourselves.",
    "Is the attending physician present?",
    "Who is the anesthesia attending?",
    "What are the names and roles of the other team members?"
  ]],
  ["Patient Identification", [
    "What is your full name?",
    "What is your date of birth?",
    "What is your Medical Record Number?"
  ]],
  ["Surgical Consent Verification", [
    "Is the consent form signed?",
    "What surgery and/or block is being performed?",
    "Which side?",
    "Is it marked?"
  ]],
  ["Local Anesthetic Plan", [
    "Which local anesthetic will be used?",
    "What is the intended concentration?",
    "What is the intended volume?"
  ]],
  ["Patient Medical Considerations", [
    "Are you currently taking any anticoagulants?",
    "Do you have any clotting disorders?",
    "Do you have any known drug allergies?",
    "Do you have a history of systemic neuropathy and/or neuropathy at the surgical site?"
  ]],
  ["Monitoring System Check", [
    "Is NIBP monitoring ready?",
    "Is ECG monitoring ready?",
    "Is SpO‚ÇÇ ready?",
    "Is EtCO‚ÇÇ monitoring ready?"
  ]],
  ["Additional Concerns", [
    "Does anyone have any other question or concern?"
  ]],
  ["Timeout Completion", [
    "Timeout completed."
  ]]
];

const checklistEl = document.getElementById("checklist");
const dotMap = new Map();

function renderChecklist(){
  checklistEl.innerHTML = "";
  GROUPS.forEach(([title, items])=>{
    const group = document.createElement("div");
    group.className = "group";
    group.innerHTML = `<h2>${title}</h2>`;
    items.forEach(sent=>{
      const row = document.createElement("div");
      row.className = "item";
      row.innerHTML = `<div>${sent}</div><div class="dot" data-sent="${sent}" title="Click to toggle"></div>`;
      group.appendChild(row);
    });
    const card = document.createElement("div");
    card.className="card";
    card.appendChild(group);
    checklistEl.appendChild(card);
  });

  document.querySelectorAll(".dot").forEach(d=>{
    dotMap.set(d.dataset.sent, d);
    d.addEventListener('click', () => d.classList.toggle('ok')); // ÊâãÂãïÂàáÊèõÁ¥Ö/Á∂†
  });
}
renderChecklist();

function resetLights(){
  dotMap.forEach(dot=>dot.classList.remove("ok"));
  document.getElementById("dl").style.display="none";
}
document.getElementById("btnReset").onclick = resetLights;

let mediaRecorder, chunks = [];
const statusEl = document.getElementById("status");
function log(s){ statusEl.textContent = (statusEl.textContent + s + "\n").slice(-4000); }

async function startRec(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    chunks = [];
    mediaRecorder = new MediaRecorder(stream, {mimeType: "audio/webm"});
    mediaRecorder.ondataavailable = e => { if (e.data.size>0) chunks.push(e.data); };
    mediaRecorder.onstop = onStopAndUpload;
    mediaRecorder.start();
    log("üéôÔ∏è Recording started‚Ä¶");
    document.getElementById("btnStart").disabled = true;
    document.getElementById("btnStop").disabled = false;
  }catch(err){
    log("Microphone error: " + err);
  }
}
document.getElementById("btnStart").onclick = startRec;

function stopRec(){
  if (mediaRecorder && mediaRecorder.state !== "inactive"){
    mediaRecorder.stop();
    document.getElementById("btnStop").disabled = true;
    document.getElementById("btnStart").disabled = false;
  }
}
document.getElementById("btnStop").onclick = stopRec;

async function onStopAndUpload(){
  log("‚èπÔ∏è Recording stopped. Uploading‚Ä¶");
  const blob = new Blob(chunks, {type:"audio/webm"});
  const fd = new FormData();
  fd.append("file", blob, "recording.webm");
  try{
    const res = await fetch(`${BACKEND_BASE}/upload-audio`, {method:"POST", body:fd});
    if(!res.ok){ throw new Error(await res.text()); }
    const data = await res.json();
    log("‚úÖ STT finished.\nMatched:\n- " + data.matched.join("\n- "));
    resetLights();
    (data.matched || []).forEach(sent=>{
      const dot = dotMap.get(sent);
      if(dot) dot.classList.add("ok");
    });
    if (data.transcript_url){
      const a = document.getElementById("dl");
      a.href = `${BACKEND_BASE}${data.transcript_url}`;
      a.textContent = "Download transcript";
      a.style.display = "inline-block";
    }
  }catch(err){
    log("‚ùå Upload/STT error: " + err);
  }
}
</script>
</body>
</html>
