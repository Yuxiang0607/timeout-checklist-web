<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>OR Timeout Checker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <!-- å­—é«” -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&family=Noto+Sans:wght@400;500&display=swap" rel="stylesheet">

  <style>
    /* ====== å…¨å±€è¨­å®š ====== */
    body {
      font-family: 'Noto Sans', 'Poppins', sans-serif;
      background: linear-gradient(135deg, #f8fafc, #eef3f7);
      margin: 0;
      padding: 40px 24px;
      color: #2c3e50;
      font-size: 20px;
      line-height: 1.6;
    }

    /* ====== å¡ç‰‡ ====== */
    .card {
      background: #fff;
      border-radius: 20px;
      border: 1px solid #e3e8ee;
      padding: 28px 32px;
      margin: 26px auto;
      max-width: 900px;
      transition: all 0.2s ease;
    }

    /* ====== æ¨™é¡Œ ====== */
    h2 {
      margin: 0 0 18px 0;
      font-weight: 600;
      font-size: 1.6em;
      color: #1e293b;
      border-left: 6px solid #0077b6;
      padding-left: 14px;
      letter-spacing: 0.5px;
    }

    /* ====== æ¯å¥é …ç›® ====== */
    .item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f9fbfd;
      border-radius: 12px;
      padding: 18px 20px;
      margin: 12px 0;
      font-size: 1.1em;
      transition: background 0.25s ease;
    }

    .item:hover {
      background: #eef4f8;
    }

    /* ====== ç‹€æ…‹ç‡ˆè™Ÿ ====== */
    .dot {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #e74c3c;
      box-shadow: 0 0 8px rgba(231, 76, 60, 0.6);
      cursor: pointer;
      transition: all 0.25s ease;
    }

    .dot.ok {
      background: #2ecc71;
      box-shadow: 0 0 10px rgba(46, 204, 113, 0.8);
      transform: scale(1.1);
    }

    /* ====== æŒ‰éˆ•ï¼ˆé«˜ç´šé…è‰²ï¼‰ ====== */
    .row {
      display: flex;
      gap: 16px;
      margin: 12px 0;
      flex-wrap: wrap;
    }

    button {
      border: none;
      border-radius: 12px;
      padding: 12px 20px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.2s ease-in-out;
      font-family: "Poppins", "Segoe UI", "Noto Sans TC", sans-serif;
    }

    /* ä¸»æŒ‰éˆ•ï¼šæ·±è—æ¼¸å±¤ + å¾®å…‰å½± */
    button.primary {
      color: #fff;
      background: linear-gradient(135deg, #1f3b74, #2c5596); /* æ·± â†’ æ·ºè— */
      box-shadow: 0 6px 14px rgba(31, 59, 116, 0.28);
      border: 1px solid rgba(255,255,255,0.08);
    }
    button.primary:hover {
      background: linear-gradient(135deg, #25448a, #3463ad);
      box-shadow: 0 10px 18px rgba(31, 59, 116, 0.34);
      transform: translateY(-1px);
    }
    button.primary:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: 0 4px 10px rgba(31, 59, 116, 0.22);
    }
    button.primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
    }

    /* æ¬¡æŒ‰éˆ•ï¼šçµ²çµ¨éŠ€ç° */
    button.secondary {
      color: #2d3748;
      background: linear-gradient(135deg, #eff3f7, #e2e7ee);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.04), 0 2px 8px rgba(0,0,0,0.06);
    }
    button.secondary:hover {
      background: linear-gradient(135deg, #e7ecf2, #dbe2ea);
      transform: translateY(-1px);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.05), 0 4px 10px rgba(0,0,0,0.10);
    }
    button.secondary:active {
      transform: translateY(1px) scale(0.99);
    }
    button.secondary:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      transform: none;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.03);
    }

    small {
      color: #6b7280;
    }

    /* ====== æ—¥èªŒå€ ====== */
    .log {
      white-space: pre-wrap;
      background: #0a0a0a;
      color: #d6ffd6;
      border-radius: 10px;
      padding: 14px;
      font-size: 15px;
      max-height: 220px;
      overflow: auto;
      margin-top: 12px;
    }

    a {
      color: #1f3b74;
      text-decoration: none;
      font-weight: 600;
    }
    a:hover { text-decoration: underline; }

    /* ====== é€²åº¦æ¢ ====== */
    #progressBarContainer {
      margin-top: 12px;
      height: 12px;
      border-radius: 10px;
      background: #e0e6eb;
      overflow: hidden;
    }

    #progressBar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #5fb0ff, #1f3b74); /* èˆ‡ä¸»è‰²ç³»ä¸€è‡´ */
      border-radius: 10px;
      transition: width 0.5s ease;
    }

    #progressText {
      margin-top: 8px;
      font-size: 16px;
      text-align: right;
      color: #475569;
    }
  </style>
</head>

<body>
  <div class="card">
    <h2>Audio Controls</h2>
    <div class="row">
      <button id="btnStart" class="primary">ğŸ™ï¸ Start</button>
      <button id="btnStop" class="secondary" disabled>â¹ï¸ Stop & Upload</button>
      <button id="btnReset" class="secondary">ğŸ”„ Reset Lights</button>
      <a id="dl" style="display:none" target="_blank">Download transcript</a>
    </div>
    <small>Recording format: WebM (Opus). Your API key stays on the server.</small>
    <div id="progressBarContainer">
      <div id="progressBar"></div>
    </div>
    <div id="progressText">0 / 0 Completed</div>
    <div id="status" class="log"></div>
  </div>

  <div class="card" id="checklist"></div>

<script>
const BACKEND_BASE = "https://timeout-checklist-server.onrender.com";

const GROUPS = [
  ["Timeout Initiation", [
    "Is everyone ready to begin the timeout?",
    "Do we have the consent form in front of us?"
  ]],
  ["Team Introduction", [
    "Please introduce yourselves.",
    "Is the attending physician present?",
    "Who is the anesthesia attending?",
    "What are the names and roles of the other team members?"
  ]],
  ["Patient Identification", [
    "What is your full name?",
    "What is your date of birth?",
    "What is your Medical Record Number?"
  ]],
  ["Surgical Consent Verification", [
    "Is the consent form signed?",
    "What surgery and/or block is being performed?",
    "Which side?",
    "Is it marked?"
  ]],
  ["Local Anesthetic Plan", [
    "Which local anesthetic will be used?",
    "What is the intended concentration?",
    "What is the intended volume?"
  ]],
  ["Patient Medical Considerations", [
    "Are you currently taking any anticoagulants?",
    "Do you have any clotting disorders?",
    "Do you have any known drug allergies?",
    "Do you have a history of systemic neuropathy and/or neuropathy at the surgical site?"
  ]],
  ["Monitoring System Check", [
    "Is NIBP monitoring ready?",
    "Is ECG monitoring ready?",
    "Is SpOâ‚‚ ready?",
    "Is EtCOâ‚‚ monitoring ready?"
  ]],
  ["Additional Concerns", [
    "Does anyone have any other question or concern?"
  ]],
  ["Timeout Completion", [
    "Timeout completed."
  ]]
];

const checklistEl = document.getElementById("checklist");
const dotMap = new Map();

function renderChecklist(){
  checklistEl.innerHTML = "";
  GROUPS.forEach(([title, items])=>{
    const group = document.createElement("div");
    group.className = "group";
    group.innerHTML = `<h2>${title}</h2>`;
    items.forEach(sent=>{
      const row = document.createElement("div");
      row.className = "item";
      row.innerHTML = `<div>${sent}</div><div class="dot" data-sent="${sent}" title="Click to toggle"></div>`;
      group.appendChild(row);
    });
    const card = document.createElement("div");
    card.className="card";
    card.appendChild(group);
    checklistEl.appendChild(card);
  });

  document.querySelectorAll(".dot").forEach(d=>{
    dotMap.set(d.dataset.sent, d);
    d.addEventListener('click', () => {
      d.classList.toggle('ok');
      updateProgress();
    });
  });

  updateProgress();
}
renderChecklist();

function updateProgress(){
  const total = dotMap.size;
  const done = [...dotMap.values()].filter(dot => dot.classList.contains('ok')).length;
  const percent = total ? (done / total) * 100 : 0;
  document.getElementById("progressBar").style.width = percent + "%";
  document.getElementById("progressText").textContent = `${done} / ${total} Completed`;
}

function resetLights(){
  dotMap.forEach(dot=>dot.classList.remove("ok"));
  document.getElementById("dl").style.display="none";
  updateProgress();
}
document.getElementById("btnReset").onclick = resetLights;

let mediaRecorder, chunks = [];
const statusEl = document.getElementById("status");
function log(s){ statusEl.textContent = (statusEl.textContent + s + "\n").slice(-4000); }

async function startRec(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    chunks = [];
    mediaRecorder = new MediaRecorder(stream, {mimeType: "audio/webm"});
    mediaRecorder.ondataavailable = e => { if (e.data.size>0) chunks.push(e.data); };
    mediaRecorder.onstop = onStopAndUpload;
    mediaRecorder.start();
    log("ğŸ™ï¸ Recording startedâ€¦");
    document.getElementById("btnStart").disabled = true;
    document.getElementById("btnStop").disabled = false;
  }catch(err){
    log("Microphone error: " + err);
  }
}
document.getElementById("btnStart").onclick = startRec;

function stopRec(){
  if (mediaRecorder && mediaRecorder.state !== "inactive"){
    mediaRecorder.stop();
    document.getElementById("btnStop").disabled = true;
    document.getElementById("btnStart").disabled = false;
  }
}
document.getElementById("btnStop").onclick = stopRec;

async function onStopAndUpload(){
  log("â¹ï¸ Recording stopped. Uploadingâ€¦");
  const blob = new Blob(chunks, {type:"audio/webm"});
  const fd = new FormData();
  fd.append("file", blob, "recording.webm");
  try{
    const res = await fetch(`${BACKEND_BASE}/upload-audio`, {method:"POST", body:fd});
    if(!res.ok){ throw new Error(await res.text()); }
    const data = await res.json();
    log("âœ… STT finished.\nMatched:\n- " + data.matched.join("\n- "));
    resetLights();
    (data.matched || []).forEach(sent=>{
      const dot = dotMap.get(sent);
      if(dot) dot.classList.add("ok");
    });
    updateProgress();
    if (data.transcript_url){
      const a = document.getElementById("dl");
      a.href = `${BACKEND_BASE}${data.transcript_url}`;
      a.textContent = "Download transcript";
      a.style.display = "inline-block";
    }
  }catch(err){
    log("âŒ Upload/STT error: " + err);
  }
}
</script>
</body>
</html>
